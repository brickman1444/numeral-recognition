<html>
    <script type="module">

    import { default as wasm_init, recognize as wasm_recognize } from "./pkg/numeral_recognition.js";

    var canvas = null,
        ctx = null,
        is_mouse_down = false,
        prevX = 0,
        currX = 0,
        prevY = 0,
        currY = 0,
        fill_style = "black",
        line_width = 2,
        w = 0,
        h = 0,
        neural_network_json_text = "";

    window.addEventListener('DOMContentLoaded', init); // Run when page loads. We can't use <body onload="init"> with a module script
    
    function init() {

        canvas = document.getElementById('can');
        ctx = canvas.getContext("2d");
        w = canvas.width;
        h = canvas.height;

        document.getElementById("recognize-button").onclick = recognize;
        document.getElementById("clear-button").onclick = erase;
    
        canvas.addEventListener("mousemove", on_mouse_move, false);
        canvas.addEventListener("mousedown", on_mouse_down, false);
        canvas.addEventListener("mouseup", on_mouse_up, false);
        canvas.addEventListener("mouseout", on_mouse_up, false);

        wasm_init().then(function() { console.log("Initialized web assmebly module."); });

        fetch("./network.json")
        .then(response => {
        return response.text();
        })
        .then(text => neural_network_json_text = text);
    }
    
    function draw() {
        ctx.beginPath();
        ctx.moveTo(prevX, prevY);
        ctx.lineTo(currX, currY);
        ctx.strokeStyle = fill_style;
        ctx.lineWidth = line_width;
        ctx.stroke();
        ctx.closePath();
    }
    
    function erase() {
        ctx.clearRect(0, 0, w, h);
    }

    function on_mouse_down(event) {
        currX = (event.clientX - canvas.offsetLeft) / parseFloat(canvas.style.width) * canvas.width;
        currY = (event.clientY - canvas.offsetTop) / parseFloat(canvas.style.height) * canvas.height;

        is_mouse_down = true;

        // Immediately draw something in case the mouse is released before it's moved
        ctx.beginPath();
        ctx.fillStyle = fill_style;
        ctx.fillRect(currX, currY, line_width, line_width);
        ctx.closePath();
    }

    function on_mouse_up(event) {
        is_mouse_down = false;
    }
    
    function on_mouse_move(event) {
        if (is_mouse_down) {
            prevX = currX;
            prevY = currY;

            currX = (event.clientX - canvas.offsetLeft) / parseFloat(canvas.style.width) * canvas.width;
            currY = (event.clientY - canvas.offsetTop) / parseFloat(canvas.style.height) * canvas.height;
            draw();
        }
    }

    function recognize() {
        console.log("recognize from javascript");

        let imageData = ctx.getImageData(0, 0, w, h);
        let rgba_bytes_array = imageData.data;

        console.log(rgba_bytes_array);

        // Stride through and save off Alpha bytes as the values to send.
        let input_data = new Uint8Array(rgba_bytes_array.length / 4);
        for (let byte_index = 3; byte_index < rgba_bytes_array.length; byte_index += 4)
        {
            input_data[Math.floor(byte_index / 4)] = rgba_bytes_array[byte_index];
        }

        console.log(input_data);

        let text = "Recognized Numeral: " + wasm_recognize(neural_network_json_text, input_data);
        document.getElementById('recognized-numeral').textContent = text;
    }
    </script>
    <body>
        <canvas id="can" width="28" height="28" style="border:2px solid; width:400px; height:400px;"></canvas>
        </br>
        <input type="button" value="Clear" id="clear-button">
        <input type="button" value="Recognize" id="recognize-button">
        <div id="recognized-numeral">Recognized Numeral: ?</div>
    </body>
    </html>